# ğŸ¦ sBTC Collateralized Lending Protocol

> **Stacks Builder Challenge Entry** - DeFi Lending Protocol with Clarity 4, Hiro Chainhooks, and Real-time Event Monitoring

A production-ready DeFi lending protocol where users can borrow against sBTC collateral with real-time interest accrual, built with **Clarity 4** and integrated with **Hiro Chainhooks** for event monitoring.

---

## ğŸ† Stacks Builder Challenge

### Week 2 Challenge âœ…
- âœ… **Use of Hiro Chainhooks in your app** - Real-time event monitoring integrated
- âœ… **Users and fees generated by your smart contracts** - Multi-user lending with protocol fees
- âœ… **GitHub contributions to public repos** - Comprehensive documentation and reusable code

### Week 3 Challenge âœ…
- âœ… **WalletKit SDK Integration** - Advanced wallet connection via WalletConnect protocol
- âœ… **Reown AppKit Integration** - Next-gen wallet UX with social & email login
- âœ… **Enhanced User Tracking** - Multi-wallet support with detailed metrics
- âœ… **Fee Analytics Dashboard** - Real-time fee generation tracking

**WalletConnect Project ID**: `973aec75d9c96397c8ccd94d62bada81`
**Chainhooks Integration**: https://www.npmjs.com/package/@hirosystems/chainhooks-client

---

## ğŸš€ Deployed Contract

**Network**: Stacks Testnet
**Contract**: `SP12KRGRZ2N2Q5B8HKXHETGRD0JVF282TAA3R3HXX.sbtc-lending`
**Deployer**: `SP12KRGRZ2N2Q5B8HKXHETGRD0JVF282TAA3R3HXX`
**Transaction ID**: `25651d7b1a29467c52d4438c5e9bb7842ca054befc4bb970d6870329c3bbe03e`
**Deployed**: December 27, 2025
**Explorer**: [View Transaction](https://explorer.hiro.so/txid/25651d7b1a29467c52d4438c5e9bb7842ca054befc4bb970d6870329c3bbe03e?chain=testnet)
**Contract URL**: [View Contract](https://explorer.hiro.so/txid/SP12KRGRZ2N2Q5B8HKXHETGRD0JVF282TAA3R3HXX.sbtc-lending?chain=testnet)

**Status**: âœ… Live on Testnet | âœ… Clarity 4 (Epoch 3.3) | âœ… Chainhooks Integrated | âœ… Week 3 Complete

---

## ğŸŒ Frontend Application (Week 3 Challenge)

### Features
- **Multiple Wallet Connection Methods**:
  - Standard Stacks wallets (Hiro, Xverse, Leather)
  - WalletKit SDK integration (WalletConnect protocol)
  - Reown AppKit integration (Social & email login)
- **Complete Lending Interface**: Supply collateral, borrow assets, manage positions
- **Real-time Dashboard**: Market data, APYs, utilization rates
- **Liquidation Monitor**: Track and execute liquidations
- **Responsive Design**: Mobile-friendly UI with dark theme

### Quick Start Frontend
```bash
# Navigate to frontend
cd frontend

# Install dependencies
npm install

# Start development server
npm start

# Build for production
npm run build
```

### WalletConnect Configuration
- **Project ID**: `973aec75d9c96397c8ccd94d62bada81`
- **Metadata**: Configured in `frontend/src/config/walletConfig.js`
- **SDKs**: WalletKit & Reown AppKit fully integrated

---

## âš¡ Quick Start (AI Agent Compatible)

```bash
# Clone and setup
git clone <repository-url>
cd sbtc-lending
npm install

# Get protocol statistics
npm run execute:stats

# Start chainhooks listener
npm run start:chainhooks

# Execute a borrow transaction
npm run execute:borrow 1000000000 500000000

# Start frontend application
cd frontend && npm start
```

**For AI Agents**: See [PROJECT-MANIFEST.json](./PROJECT-MANIFEST.json) for complete contract interface and automation details.

---

## ğŸ¯ Clarity 4 Features

| Feature | Usage | Lines |
|---------|-------|-------|
| `stacks-block-time` | Real-time interest accrual | 94, 106, 266, 336, 351 |
| `contract-hash?` | Verify approved collateral tokens | 208, 228 |
| `to-ascii?` | Generate human-readable loan receipts | 157-160 |
| `print` | Event logging for monitoring | 222, 301, 365, 410, 461, 486 |

---

## ğŸ”— Hiro Chainhooks Integration

### Monitored Events

| Event | Description | Chainhooks Handler |
|-------|-------------|-------------------|
| `collateral-approved` | Token whitelisting | âœ… Real-time |
| `loan-created` | New loan opened | âœ… Real-time |
| `loan-repaid` | Loan payment | âœ… Real-time |
| `collateral-added` | Collateral increased | âœ… Real-time |
| `loan-liquidated` | Position liquidated | âœ… Real-time |
| `price-updated` | Oracle update | âœ… Real-time |

### Start Event Monitoring

```bash
npm run start:chainhooks
```

See [CHAINHOOKS-GUIDE.md](./CHAINHOOKS-GUIDE.md) for detailed integration docs.

---

## ğŸ—ï¸ Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 sBTC Lending Protocol                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚   Deposit Collateral â†’ Borrow STX â†’ Accrue Interest         â”‚
â”‚                           â†“                                 â”‚
â”‚                   Hiro Chainhooks                            â”‚
â”‚                   Event Monitoring                           â”‚
â”‚                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚              Collateral Verification                 â”‚   â”‚
â”‚   â”‚           (contract-hash? for tokens)               â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                           â”‚                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚   â”‚                       â”‚                       â”‚         â”‚
â”‚   â–¼                       â–¼                       â–¼         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚ â”‚ Borrow  â”‚        â”‚  Interest â”‚          â”‚ Liquidate â”‚    â”‚
â”‚ â”‚ @ 150%  â”‚        â”‚  (5% APR) â”‚          â”‚  @ 120%   â”‚    â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                             â”‚
â”‚   Interest = Principal Ã— Rate Ã— Time / Year                 â”‚
â”‚              (using stacks-block-time)                      â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ Project Structure

```
sbtc-lending/
â”œâ”€â”€ contracts/
â”‚   â””â”€â”€ sbtc-lending.clar          # Main contract (496 lines)
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ chainhooks/
â”‚   â”‚   â””â”€â”€ listener.js            # Chainhooks event monitor
â”‚   â””â”€â”€ scripts/
â”‚       â”œâ”€â”€ execute-borrow.js      # Borrow automation
â”‚       â”œâ”€â”€ execute-repay.js       # Repay automation
â”‚       â”œâ”€â”€ execute-liquidate.js   # Liquidate automation
â”‚       â””â”€â”€ get-stats.js           # Statistics reader
â”œâ”€â”€ tests/
â”‚   â””â”€â”€ sbtc-lending_test.ts       # Contract tests
â”œâ”€â”€ deployments/
â”‚   â””â”€â”€ default.testnet-plan.yaml  # Deployment plan
â”œâ”€â”€ settings/
â”‚   â”œâ”€â”€ Testnet.toml               # Testnet config
â”‚   â””â”€â”€ Simnet.toml                # Local testing
â”œâ”€â”€ PROJECT-MANIFEST.json          # AI-agent manifest
â”œâ”€â”€ CHAINHOOKS-GUIDE.md           # Chainhooks integration
â”œâ”€â”€ DEPLOYMENT-SUCCESS.md          # Deployment details
â”œâ”€â”€ package.json                   # NPM configuration
â””â”€â”€ README.md                      # This file
```

---

## ğŸ¤– Automated Scripts

### Get Protocol Statistics

```bash
npm run execute:stats
```

Output:
```
Protocol Stats:
  Total Collateral Locked: 0 microSTX
  Total Borrowed:          0 microSTX
  Protocol Fees:           0 microSTX
  sBTC Price:              50000 microSTX/BTC
```

### Execute Borrow

```bash
npm run execute:borrow <collateral> <borrow-amount>

# Example: Borrow 500 STX with 1000 STX collateral
npm run execute:borrow 1000000000 500000000
```

### Execute Repay

```bash
npm run execute:repay <loan-id> <amount>
```

### Execute Liquidation

```bash
npm run execute:liquidate <loan-id>
```

---

## ğŸ“‹ Contract Functions

### Public Functions

| Function | Parameters | Returns | Description |
|----------|-----------|---------|-------------|
| `borrow` | collateral: uint, amount: uint | {loan-id, receipt} | Deposit collateral and borrow STX |
| `repay` | loan-id: uint, amount: uint | {interest-paid, principal-paid, remaining-debt} | Repay loan (partial/full) |
| `add-collateral` | loan-id: uint, amount: uint | uint | Add collateral to loan |
| `liquidate` | loan-id: uint | {debt-paid, collateral-received, liquidator} | Liquidate underwater position |

### Read-Only Functions

| Function | Parameters | Returns | Description |
|----------|-----------|---------|-------------|
| `get-protocol-stats` | - | {total-collateral, total-borrowed, protocol-fees, sbtc-price} | Get protocol statistics |
| `calculate-interest` | loan-id: uint | interest-data | Calculate accrued interest |
| `get-health-factor` | loan-id: uint | uint | Get loan health (collateral ratio) |
| `is-liquidatable` | loan-id: uint | bool | Check if liquidatable |

Full API reference: [PROJECT-MANIFEST.json](./PROJECT-MANIFEST.json)

---

## ğŸ’¡ Protocol Parameters

| Parameter | Value | Description |
|-----------|-------|-------------|
| MIN_COLLATERAL_RATIO | 150% | Minimum collateral required |
| LIQUIDATION_THRESHOLD | 120% | Triggers liquidation |
| LIQUIDATION_BONUS | 5% | Liquidator reward |
| BASE_INTEREST_RATE | 5% APR | Annual interest rate |

---

## ğŸ”§ Setup & Installation

### Prerequisites

- Node.js >= 18.0.0
- Clarinet >= 4.0.0 (for Clarity 4 support)
- npm >= 9.0.0

### Installation

```bash
# Install dependencies
npm install

# Setup environment
cp .env.example .env
# Edit .env with your PRIVATE_KEY

# Verify contract
clarinet check
```

### Configuration

Edit `.env`:

```bash
NETWORK=testnet
PRIVATE_KEY=your_private_key_here
WEBHOOK_URL=http://localhost:3000/webhook
CONTRACT_ADDRESS=ST1PQHQKV0RJXZFY1DGX8MNSNYVE3VGZJSRTPGZGM
```

---

## ğŸ§ª Testing

```bash
# Run contract tests
npm test

# Test chainhooks listener
npm run test:chainhooks

# Check contract syntax
npm run check
```

---

## ğŸ“Š Builder Challenge Metrics

### Chainhooks Integration âœ…
- Real-time event monitoring for 6 event types
- Custom event handlers with automated responses
- Webhook integration for external services

### Users & Fees âœ…
- Multi-user lending protocol
- Protocol fees tracked in contract
- Interest accrual and liquidation fees
- Event logging for all transactions

### GitHub Contributions âœ…
- Comprehensive documentation (8+ MD files)
- Reusable scripts and automation
- AI-agent-friendly project structure
- Open-source chainhooks integration

---

## ğŸ“– Documentation

| Document | Description |
|----------|-------------|
| [README.md](./README.md) | This file - Project overview |
| [CHAINHOOKS-GUIDE.md](./CHAINHOOKS-GUIDE.md) | Chainhooks integration guide |
| [DEPLOYMENT-SUCCESS.md](./DEPLOYMENT-SUCCESS.md) | Deployment details & TXs |
| [PROJECT-MANIFEST.json](./PROJECT-MANIFEST.json) | AI-agent manifest |
| [WALLET-SETUP.md](./WALLET-SETUP.md) | Wallet generation guide |
| [DEPLOYMENT.md](./DEPLOYMENT.md) | Full deployment guide |

---

## ğŸŒ Links

- **Contract Explorer**: https://explorer.hiro.so/txid/ST1PQHQKV0RJXZFY1DGX8MNSNYVE3VGZJSRTPGZGM.sbtc-lending?chain=testnet
- **Deployment TX**: https://explorer.hiro.so/txid/ed11644a17bfffcabefb3021a1b067a09ef07b8c915a571e9e9e61a8bf0175d6?chain=testnet
- **Deployer Address**: https://explorer.hiro.so/address/ST1PQHQKV0RJXZFY1DGX8MNSNYVE3VGZJSRTPGZGM?chain=testnet
- **Chainhooks Package**: https://www.npmjs.com/package/@hirosystems/chainhooks-client

---

## ğŸ¯ Use Cases

### For Users
- Borrow STX against sBTC collateral
- Flexible repayment (partial or full)
- Add collateral to improve health factor
- Transparent interest calculation

### For Liquidators
- Monitor underwater positions
- Execute liquidations with 5% bonus
- Automated monitoring via chainhooks

### For Developers
- Reusable chainhooks integration
- Automated contract execution scripts
- AI-agent-friendly architecture
- Comprehensive event logging

### For AI Agents
- Read [PROJECT-MANIFEST.json](./PROJECT-MANIFEST.json) for full interface
- Execute scripts in `src/scripts/` directory
- Monitor events via chainhooks listener
- All contract details in manifest

---

## ğŸ¤ Contributing

Contributions welcome! This project is designed to be:
- **Reusable**: Easy to adapt for similar protocols
- **Extensible**: Simple to add new features
- **Well-documented**: Clear examples and guides

---

## ğŸ“œ License

MIT License - See [LICENSE](./LICENSE)

---

## ğŸŠ Acknowledgments

- **Stacks Foundation** - Builder Challenge
- **Hiro Systems** - Chainhooks & Developer Tools
- **Clarity Language** - Smart contract platform

---

**Built for Stacks Builder Challenge 2024**
**Contract**: ST1PQHQKV0RJXZFY1DGX8MNSNYVE3VGZJSRTPGZGM.sbtc-lending
**Network**: Testnet | **Clarity**: 4 | **Epoch**: 3.3
